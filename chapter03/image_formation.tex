\subsection{Image Formation and Camera Models}

Each depth sensors measurement returns a matrix with depth or range values.
The projection model of the sensor performs the calculation of the camera coordinates for each point.
Additionally, sensor usually experience some form of imperfection in the imaging process, like lense distortion or misalignment of components.
These imperfections are corrected with additional models, like the distortion model for pinhole cameras.

Both calibration and error correction are out of the scope of this thesis and sensor input is expected to adhere to the basic models.
This might require preprocessing of the raw sensor data.
On robotic platforms like \acrlong{ROS} this is done automatically when providing a matching calibration of the sensor.

\subsubsection{Pinhole Camera Model}

The pinhole camera model is the most common camera model in computer vision modelling both classical and depth cameras.

\begin{figure}[H]
    \includegraphics[width=0.6\textwidth]{chapter03/img/pinhole_camera_model.png}
    \caption[Pinhole Camera Model]{The pinhole camera model performs the perspective projection of three dimensional points into the plane. Real cameras additionally have a lense system that can result in radial and tangential distortion. These effects must be componsenated with a proper calibration of distortion models. The camera-coordinate-to-pixel-coordinate projection looses information on the depth. Therefore, the back projection results only in the direction of the light ray. The depth sensor gives the additional distance information to recover the point in camera coordinates. Graphic adopted from\cite{opencv_pinhole}.}\label{fig:pinhole_model}
\end{figure}
Figure~\ref{fig:pinhole_model} shows the perspective projection of three-dimensional points onto the plane.
This projection reduces the input dimension by one and is not depth preserving.

The model is parameterized by the focal length $f_x$ and $f_y$ that correspond to the distance of the pinhole to the image plane, the skew $s$ that resembles non-quadratic pixel shape and is most of the time $s = 0$ and the image center $c_x$ and $c_y$.

\subsubsection*{Forward Projection}

Let $\vec{P} = \rowvecxxx{X}{Y}{Z}$ be a world point in camera coordinates.
The perspective projection
\begin{equation}
    \vec{\hat{p}} = \colvecxxx{x}{y}{1} = \frac{1}{Z}\colvecxxx{X}{Y}{Z}
    \label{eq:pinhole_forward}
\end{equation}
results in the point $\vec{P}$ in image coordinates $\vec{\hat{p}}$. This step looses the depth information.
The image coordinates could be distorted and any correction would happen at this stage.
Multiplication of the $3 \times 3$ camera matrix $K$ and the homogeneous image coordinates results in the final pixel coordinates.
\begin{equation}
\begin{aligned}
K &= \begin{pmatrix}
        f_x & f_x s & c_x \\
        0   & f_y   & c_y \\
        0   & 0     & 1
     \end{pmatrix} \\
K \vec{\hat{p}} &= \begin{pmatrix}
        f_x & f_x s & c_x \\
        0   & f_y   & c_y \\
        0   & 0     & 1
     \end{pmatrix}\colvecxxx{x}{y}{1} = \colvecxxx{u}{v}{1} = \vec{p}
\end{aligned}
\end{equation}

\subsubsection*{Backward Projection}

Applying the inverse transformations allows to recover the direction of the light matching a pixel $\vec{p}$.
The potentially distorted image coordinates $\vec{\hat{p}}$ are obtained with the following formula.
\begin{equation}
\begin{aligned}
    \vec{\hat{p}} = \colvecxxx{x}{y}{1} &= K^{-1} \vec{p} \\
    \colvecxx{x}{y} &= \begin{pmatrix}\frac{1}{f_x} & -\frac{s}{f_y} \\ 0 & \frac{1}{f_y}\end{pmatrix} \colvecxx{u - c_x}{v - c_y}
\end{aligned}
\end{equation}
Again, if a distortion model is used, the inverse transformation needs to be applied to $\vec{\hat{p}}$.

The final step is the projection to the unit sphere that gives the direction vector of the light ray equivalent to norming the vector $\vec{\hat{p}}$.
\begin{equation}
    \colvecxxx{Xs}{Ys}{Zs} = \frac{1}{\sqrt{x^2 + y^2 + 1}} \colvecxxx{x}{y}{1}
    \label{eq:pinhole_backward}
\end{equation}

\subsubsection{Equirectangular Camera Model}

The equirectangular camera model maps the whole unit sphere to the plane.
Equirectangular images have constant, but potentially different angular resolution in $x$- and $y$-direction.
This mapping stores panoramas that are usually stitched together from multiple cameras.
The \acrshort{LIDAR} sensor output can be stored as an equirectangular image as well.
Supporting this camera model gives flexibility to support all kind of sensors as multiple pinhole sensors can be stitched to one virtual sensor and mapped to the equirectangular model.

\begin{figure}[H]
    \scalebox{0.9}{%
    \input{chapter03/img/spherical_model.tex}
    }
    \caption[Spherical Camera Model and Equirectangular Images]{Each cartesian point that is not the origin can be uniquely converted to spherical coordinates. The origin $\mathbf{O}$ is interpreted as an invalid measurement in the context of this thesis and therefore filtered out during processing.}\label{fig:spherical}
\end{figure}

The projections are mostly a conversion from cartesian to spherical coordinates and described here in brief.
Additionally, to suite the \acrshort{LIDAR} sensor better a slight addition for a vertical field of view is added.
This field of view simply crops the full equirectangular image to the predefined slice and discards other coordinates as invalid.
Figure~\ref{fig:spherical} shows the relationship between points in spherical coordinates and the equirectangular projection.

The model is parametrized by the width $w$ and height $h$ of the image and the vertical field of view $[\theta_{min}, \theta_{max}]$ which defaults to $\theta_{min} = 0$ and $\theta_{max} = \pi$.
This definition yields the vertical and horizontal angular resolution of a pixel, which is a constant.
\begin{equation}
\label{eq:equi_angular_resolution}
\begin{aligned}
    d\varphi &= \frac{2 \pi}{w} \\
    d\theta &= \frac{\theta_{max} - \theta_{min}}{h} \\
\end{aligned}
\end{equation}
The used spherical coordinates $z = (r, \varphi, \theta)$ convention defines the radius $r \in \mathbb{R}$, the azimuthal angle $\varphi \in [-\pi, \pi)$ and the polar angle $\theta \in [0, \pi]$.
Measurements with $r = 0$ are filtered out as invalid data points.

\subsubsection*{Forward Projection}

Let $\vec{P} = \rowvecxxx{X}{Y}{Z}$ be a point in camera coordinates.
This point is converted to spherical coordinates.
\begin{equation}
\begin{aligned}
    r       &= \sqrt{X^2 + Y^2 + Z^2} \\
    \theta  &= \arccos{\frac{Z}{r}} \\
    \varphi &= \arctantwo{\frac{Y}{X}}
\end{aligned}
\end{equation}
This conversion is ill defined for $r = 0$ which corresponds to a missing range measurement and can be skipped safely.
Finally, the spherical coordinates are converted to pixel coordinates with
\begin{equation}
\begin{aligned} 
    \colvecxx{u}{v} = \colvecxx{\frac{\varphi + \pi}{d\varphi}}{\frac{\theta}{d\theta}}
\end{aligned}
\end{equation}

\subsubsection*{Backward Projection}

The backward projection recovers the light ray direction from pixel coordinates.
It is analogous to the forward projection mainly a conversion from spherical to cartesian coordinates.
Note, that $r = 1$ as the resulting vector is of unit length.
\begin{equation}
\begin{aligned}
    \varphi &= u d\varphi - \pi \\
    \theta &= \theta_{min} + v d\theta \\
    \colvecxxx{X_s}{Y_s}{Z_s} &= \colvecxxx{\sin \theta \cos \varphi}{\sin \theta \sin \varphi}{\cos \theta}
\end{aligned}
\end{equation}

\subsubsection{Range and Depth Conversion}\label{sec:range_depth_conversion}

\begin{figure}[H]
    \scalebox{0.8}{%
    \input{chapter03/img/depth_range}
    }
    \caption[Orthographic Depth and Range visualized]{The distance information of a point relative to the center of a sensor at $\vec{C}$ can either be stored as the orthographic depth, mathematically the $Z$ component of the camera coordinates or the range, equivalent to the $L2$ norm of the point $\vec{P}$ in camera coordinates. The orthographic depth is commonly provided by depth cameras and the range by \acrshort{LIDAR} systems.}
    \label{fig:range_depth}
\end{figure}

There are two possible conventions on how to store depth data, both demonstrated in figure~\ref{fig:range_depth}.
The orthographic depth $d$ is the distance from the image plane and commonly returned by pinhole depth sensors like the Kinectv2.
On the other hand, the range $r$ is the $L2$ norm of the vector from the camera origin to $\vec{P}$.
For consistency and generality, depth data is converted to range data before further processing takes place.
This simplifies later conversion and mixing of different camera models in a coherent fashion.
The conversion depends on the camera model and only the pinhole model is subject to analysis here.

From the forward projection function~\ref{eq:pinhole_forward} of the pinhole model follows the connection of the range and orthographic depth of the camera coordinates $\vec{P}$ and image coordinates $\vec{\hat{p}}$ of the point $\mathbf{P}$.
\begin{equation}
\begin{aligned}
    &\vec{\hat{p}} = \colvecxxx{x}{y}{1} = \frac{1}{Z}\colvecxxx{X}{Y}{Z} \\
    \implies &Z \vec{\hat{p}} = \vec{P} \\
    \implies &Z \lnorm{\vec{\hat{p}}} = \lnorm{\vec{P}}
\end{aligned}
\end{equation}
The inverse of the $Z_{s}$ component of the backward projection from equation~\ref{eq:pinhole_backward} provides the scaling factor between orthographic depth and range.
Consequently, the range $r$ for the depth $d$ at image coordiantes $\rowvecxx{x}{y}$ with corresponding coordinates on the unit sphere $\rowvecxxx{X_s}{Y_s}{Z_s}$ is computed with
\begin{equation}
    r = \frac{d}{Z_s} = d \sqrt{x^2 + y^2 + 1}\text{.}
\end{equation}
